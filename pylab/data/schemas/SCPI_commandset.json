{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "SCPI Command Set Schema",
  "type": "object",
  "required": [
    "info",
    "commands"
  ],
  "properties": {
    "info": {
      "type": "object",
      "required": [
        "device",
        "description"
      ],
      "properties": {
        "device": { "type": "string" },
        "description": { "type": "string" },
        "notes": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    },
    "commands": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": [
          "set",
          "query",
          "help",
          "response"
        ],
        "properties": {
          "set": {
            "anyOf": [
              { "$ref": "#/definitions/argArray" },
              { "type": "null" }
            ]
          },
          "query": {
            "anyOf": [
              { "$ref": "#/definitions/argArray" },
              { "type": "null" }
            ]
          },
          "response": {
            "anyOf": [
              { "$ref": "#/definitions/argArray" },
              { "type": "null" }
            ]
          },
          "help": { "type": "string" }
        },
        "additionalProperties": false,
        "allOf": [
          {
            "if": { "properties": { "query": { "not": { "type": "null" } } } },
            "then": { "properties": { "response": { "not": { "type": "null" } } } }
          }
        ]
      }
    }
  },
  "definitions": {
    "argArray": {
      "type": "array",
      "items": { "$ref": "#/definitions/argItem" },
      "allOf": [
        {
          "if": { "minItems": 2 },
          "then": {
            "items": [
              {
                "allOf": [
                  { "$ref": "#/definitions/argItem" },
                  { "properties": { "required": { "const": true } } }
                ]
              }
            ],
            "additionalItems": { "$ref": "#/definitions/argItem" }
          }
        },
        {
          "not": {
            "contains": {
              "properties": { "variadic": { "const": true } },
              "minContains": 2
            }
          }
        },
        {
          "if": {
            "contains": { "properties": { "variadic": { "const": true } } }
          },
          "then": {
            "oneOf": [
              {
                "items": [],
                "additionalItems": { "$ref": "#/definitions/argItemVariadic" },
                "maxItems": 1
              },
              {
                "items": { "$ref": "#/definitions/argItemNonVariadic" },
                "additionalItems": false,
                "contains": { "properties": { "variadic": { "const": true } } },
                "allOf": [
                  {
                    "items": [],
                    "additionalItems": { "$ref": "#/definitions/argItemNonVariadic" }
                  },
                  {
                    "anyOf": [
                      { "maxItems": 1 },
                      {
                        "items": [],
                        "additionalItems": { "$ref": "#/definitions/argItemNonVariadic" },
                        "minItems": 1
                      }
                    ]
                  }
                ]
              },
              {
                "items": [
                  { "$ref": "#/definitions/argItemNonVariadic" }
                ],
                "additionalItems": { "$ref": "#/definitions/argItemNonVariadic" },
                "allOf": [
                  {
                    "if": { "minItems": 1 },
                    "then": {
                      "items": { "$ref": "#/definitions/argItemNonVariadic" },
                      "additionalItems": {
                        "oneOf": [
                          { "$ref": "#/definitions/argItemNonVariadic" },
                          { "$ref": "#/definitions/argItemVariadic" }
                        ]
                      }
                    }
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "argItem": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "enum": [ "bool", "int", "float", "str" ] },
        "required": { "type": "boolean" },
        "default": {},
        "range": {
          "type": "array",
          "items": [
            { "type": [ "number", "null", "string" ] },
            { "type": [ "number", "null", "string" ] }
          ],
          "minItems": 2,
          "maxItems": 2
        },
        "values": {
          "type": "array",
          "items": { "type": [ "string", "number", "boolean" ] }
        },
        "variadic": { "type": "boolean" }
      },
      "required": [ "type" ],
      "additionalProperties": true
    },
    "argItemNonVariadic": {
      "allOf": [
        { "$ref": "#/definitions/argItem" },
        { "not": { "properties": { "variadic": { "const": true } } } }
      ]
    },
    "argItemVariadic": {
      "allOf": [
        { "$ref": "#/definitions/argItem" },
        { "properties": { "variadic": { "const": true } } }
      ]
    }
  }
}
